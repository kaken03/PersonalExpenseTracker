{% extends 'base.html' %}

{% block title %}Dashboard - Expense Tracker{% endblock %}

{% block content %}
<!-- <div class="row mb-5">
    <div class="col-12">
        <h2 class="mb-0">Dashboard</h2>
        <p class="text-muted mt-2">Manage and track your monthly expenses</p>
    </div>
</div> -->

<div class="row mb-14">
    <div class="col-12 mb-3 text-center">
        <h3 class="text-primary">Welcome, {{ user.first_name|default:user.username }}! ðŸ‘‹</h3>
        <p class="text-muted">Here's your expense summary</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12 col-md-6 mb-3 mb-md-0">
        <div class="dash-stat">
            <h6 class="text-white-50">Monthly Total</h6>
            <h3 id="monthlyTotalAmount">${{ monthly_total|floatformat:2 }}</h3>
        </div>
    </div>
    <div class="col-12 col-md-6">
        <div class="dash-stat" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
            <h6 class="text-white-50">Total Expenses</h6>
            <h3 id="expenseCountAmount">{{ expense_count }}</h3>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12 col-md-8">
        <!-- <h4 class="mb-3">Category Filter</h4> -->
        <select id="categoryFilter" class="form-select">
            <option value="">All Categories</option>
            <option value="food">Food</option>
            <option value="transport">Transport</option>
            <option value="bills">Bills</option>
            <option value="shopping">Shopping</option>
            <option value="other">Other</option>
        </select>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h4 class="mb-4">Recent Expenses</h4>
        
        {% if recent_expenses %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th class="d-none d-md-table-cell">Description</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for expense in recent_expenses %}
                            <tr data-expense-id="{{ expense.pk }}">
                                <td><small class="d-md-auto">{{ expense.date|date:"M d" }}</small></td>
                                <td><span class="badge bg-primary">{{ expense.get_category_display }}</span></td>
                                <td class="d-none d-md-table-cell"><small>{{ expense.description|truncatewords:5 }}</small></td>
                                <td><strong>${{ expense.amount|floatformat:2 }}</strong></td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-info view-expense-btn" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#viewExpenseModal"
                                                data-id="{{ expense.pk }}"
                                                data-date="{{ expense.date|date:'Y-m-d' }}"
                                                data-category="{{ expense.get_category_display }}"
                                                data-category-code="{{ expense.category }}"
                                                data-amount="{{ expense.amount|floatformat:2 }}"
                                                data-description="{{ expense.description }}"
                                                data-created="{{ expense.created_at|date:'M d, Y H:i' }}">View</button>
                                        <button type="button" class="btn btn-warning edit-expense-btn" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editExpenseModal"
                                                data-id="{{ expense.pk }}"
                                                data-date="{{ expense.date|date:'Y-m-d' }}"
                                                data-category="{{ expense.category }}"
                                                data-amount="{{ expense.amount }}"
                                                data-description="{{ expense.description }}">Edit</button>
                                        <button type="button" class="btn btn-danger delete-expense-btn" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#deleteExpenseModal"
                                                data-id="{{ expense.pk }}"
                                                data-category="{{ expense.get_category_display }}"
                                                data-amount="{{ expense.amount|floatformat:2 }}"
                                                data-description="{{ expense.description }}"
                                                data-date="{{ expense.date|date:'Y-m-d' }}">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info" role="alert">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <span>No expenses yet. Start tracking your spending!</span>
                    <!-- <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addExpenseModal">Add Expense</button> -->
                </div>
            </div>
        {% endif %}
        
        <div class="mt-4 d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addExpenseModal">Add New Expense</button>
        </div>
    </div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1" aria-labelledby="addExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="addExpenseModalLabel">Add New Expense</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addExpenseForm" method="post" action="{% url 'expense_create' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="addDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="addDate" name="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="addCategory" class="form-label">Category</label>
                        <select class="form-select" id="addCategory" name="category" required>
                            <option value="">Select a category</option>
                            <option value="food">Food</option>
                            <option value="transport">Transport</option>
                            <option value="bills">Bills</option>
                            <option value="shopping">Shopping</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addAmount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="addAmount" name="amount" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="addDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="addDescription" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="addExpenseBtn">Create Expense</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="viewExpenseModal" tabindex="-1" aria-labelledby="viewExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="viewExpenseModalLabel">Expense Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item">
                        <small class="text-muted">Date</small>
                        <p id="viewDate" class="mb-0"></p>
                    </div>
                    <div class="list-group-item">
                        <small class="text-muted">Category</small>
                        <p id="viewCategory" class="mb-0"><span class="badge bg-primary"></span></p>
                    </div>
                    <div class="list-group-item">
                        <small class="text-muted">Amount</small>
                        <p id="viewAmount" class="mb-0 h6"></p>
                    </div>
                    <div class="list-group-item">
                        <small class="text-muted">Description</small>
                        <p id="viewDescription" class="mb-0"></p>
                    </div>
                    <div class="list-group-item">
                        <small class="text-muted">Created</small>
                        <p id="viewCreated" class="mb-0"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <!-- <button type="button" class="btn btn-warning" id="editFromViewBtn" data-bs-toggle="modal" data-bs-target="#editExpenseModal">Edit</button> -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Expense Modal -->
<div class="modal fade" id="editExpenseModal" tabindex="-1" aria-labelledby="editExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="editExpenseModalLabel">Edit Expense</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editExpenseForm" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="editDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editDate" name="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCategory" class="form-label">Category</label>
                        <select class="form-select" id="editCategory" name="category" required>
                            <option value="food">Food</option>
                            <option value="transport">Transport</option>
                            <option value="bills">Bills</option>
                            <option value="shopping">Shopping</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editAmount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="editAmount" name="amount" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="editSaveBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Expense Modal -->
<div class="modal fade" id="deleteExpenseModal" tabindex="-1" aria-labelledby="deleteExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger bg-opacity-10">
                <h5 class="modal-title text-danger" id="deleteExpenseModalLabel">Delete Expense?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Are you sure you want to delete this expense? This action cannot be undone.</p>
                <div class="alert alert-danger" role="alert">
                    <strong id="deleteCategory"></strong> - $<span id="deleteAmount"></span>
                    <br><small id="deleteDescription"></small>
                    <br><small id="deleteDate"></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteExpenseForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" id="deleteConfirmBtn" class="btn btn-danger">Delete Permanently</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Delete Form -->
<form id="hiddenDeleteForm" method="post" style="display: none;">
    {% csrf_token %}
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentExpenseId = null;
    
    // Get CSRF token
    function getCSRFToken() {
        return document.querySelector('[name="csrfmiddlewaretoken"]')?.value || '';
    }
    
    // Auto-refresh monthly total and expense count every 5 seconds
    function updateStats() {
        fetch('{% url "dashboard_stats" %}', {
            method: 'GET',
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
            document.getElementById('monthlyTotalAmount').textContent = '$' + parseFloat(data.monthly_total).toFixed(2);
            document.getElementById('expenseCountAmount').textContent = data.expense_count;
        })
        .catch(e => console.error('Error fetching stats:', e));
    }
    
    // Refresh stats every 5 seconds
    setInterval(updateStats, 5000);
    
    // Category filter
    document.getElementById('categoryFilter')?.addEventListener('change', function() {
        const category = this.value;
        const tbody = document.querySelector('tbody');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
            if (category === '') {
                row.style.display = '';
            } else {
                const badge = row.querySelector('.badge');
                const rowCategory = badge ? badge.textContent.toLowerCase() : '';
                row.style.display = rowCategory.includes(category) ? '' : 'none';
            }
        });
    });
    
    // Update expense in existing table row (update cell values only)
    function updateTableRow(expenseId, date, category, description, amount) {
        const row = document.querySelector(`tr[data-expense-id="${expenseId}"]`);
        if (!row) return;
        
        const cells = row.querySelectorAll('td');
        // Date cell
        cells[0].innerHTML = `<small class="d-md-auto">${new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</small>`;
        // Category cell
        cells[1].innerHTML = `<span class="badge bg-primary">${category}</span>`;
        // Description cell (hidden on mobile)
        const desc = description || 'â€”';
        cells[2].innerHTML = `<small>${desc.length > 25 ? desc.substring(0, 25) + '...' : desc}</small>`;
        // Amount cell
        cells[3].innerHTML = `<strong>$${parseFloat(amount).toFixed(2)}</strong>`;
    }
    
    // Add new expense row to table
    function addTableRow(expense) {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;
        
        const row = document.createElement('tr');
        row.setAttribute('data-expense-id', expense.id);
        row.innerHTML = `
            <td><small class="d-md-auto">${new Date(expense.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</small></td>
            <td><span class="badge bg-primary">${expense.category}</span></td>
            <td class="d-none d-md-table-cell"><small>${expense.description || 'â€”'}</small></td>
            <td><strong>$${parseFloat(expense.amount).toFixed(2)}</strong></td>
            <td>
                <div class="btn-group btn-group-sm flex-wrap" role="group">
                    <button type="button" class="btn btn-info view-expense-btn" data-bs-toggle="modal" data-bs-target="#viewExpenseModal"
                        data-id="${expense.id}" data-date="${expense.date}" data-category="${expense.category}" data-category-code="${expense.category_code}"
                        data-amount="${expense.amount}" data-description="${expense.description}" data-created="${expense.created_at}">View</button>
                    <button type="button" class="btn btn-warning edit-expense-btn" data-bs-toggle="modal" data-bs-target="#editExpenseModal"
                        data-id="${expense.id}" data-date="${expense.date}" data-category="${expense.category_code}"
                        data-amount="${expense.amount}" data-description="${expense.description}">Edit</button>
                    <button type="button" class="btn btn-danger delete-expense-btn" data-bs-toggle="modal" data-bs-target="#deleteExpenseModal"
                        data-id="${expense.id}" data-category="${expense.category}" data-amount="${expense.amount}"
                        data-description="${expense.description}" data-date="${expense.date}">Delete</button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    }
    
    // Modal data handlers
    document.getElementById('viewExpenseModal')?.addEventListener('show.bs.modal', function(event) {
        const btn = event.relatedTarget;
        document.getElementById('viewDate').textContent = btn.dataset.date;
        document.getElementById('viewCategory').innerHTML = `<span class="badge bg-primary">${btn.dataset.category}</span>`;
        document.getElementById('viewAmount').textContent = '$' + parseFloat(btn.dataset.amount).toFixed(2);
        document.getElementById('viewDescription').textContent = btn.dataset.description || 'â€”';
        document.getElementById('viewCreated').textContent = btn.dataset.created;
    });

    document.getElementById('editExpenseModal')?.addEventListener('show.bs.modal', function(event) {
        const btn = event.relatedTarget;
        currentExpenseId = btn.dataset.id;
        document.getElementById('editDate').value = btn.dataset.date;
        document.getElementById('editCategory').value = btn.dataset.category;
        document.getElementById('editAmount').value = btn.dataset.amount;
        document.getElementById('editDescription').value = btn.dataset.description || '';
    });

    document.getElementById('deleteExpenseModal')?.addEventListener('show.bs.modal', function(event) {
        const btn = event.relatedTarget;
        currentExpenseId = btn.dataset.id;
        document.getElementById('deleteCategory').textContent = btn.dataset.category;
        document.getElementById('deleteAmount').textContent = btn.dataset.amount;
        document.getElementById('deleteDescription').textContent = btn.dataset.description || '(No description)';
        document.getElementById('deleteDate').textContent = btn.dataset.date;
    });

    // Add Expense
    document.getElementById('addExpenseBtn')?.addEventListener('click', function() {
        const form = document.getElementById('addExpenseForm');
        const formData = new FormData(form);
        formData.append('csrfmiddlewaretoken', getCSRFToken());
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCSRFToken()}
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                const tbody = document.querySelector('tbody');
                if (!tbody) {
                    // Create table if it doesn't exist
                    const empty = document.querySelector('.alert-info');
                    if (empty) {
                        empty.outerHTML = `<div class="table-responsive"><table class="table table-hover mb-0"><thead><tr><th>Date</th><th>Category</th><th class="d-none d-md-table-cell">Description</th><th>Amount</th><th>Actions</th></tr></thead><tbody></tbody></table></div>`;
                    }
                }
                addTableRow(data.expense);
                form.reset();
                document.getElementById('addDate').value = new Date().toISOString().split('T')[0];
                bootstrap.Modal.getInstance(document.getElementById('addExpenseModal')).hide();
                showToast('Expense added!', 'success');
                updateStats();
            }
        })
        .catch(e => showToast('Error adding expense', 'error'));
    });

    // Edit Expense
    document.getElementById('editSaveBtn')?.addEventListener('click', function() {
        const form = document.getElementById('editExpenseForm');
        const formData = new FormData(form);
        formData.append('csrfmiddlewaretoken', getCSRFToken());
        
        fetch(`{% url "expense_update" 99999 %}`.replace('99999', currentExpenseId), {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCSRFToken()}
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                const exp = data.expense;
                updateTableRow(exp.id, exp.date, exp.category, exp.description, exp.amount);
                
                // Update the button data attributes too
                const row = document.querySelector(`tr[data-expense-id="${exp.id}"]`);
                const viewBtn = row.querySelector('.view-expense-btn');
                const editBtn = row.querySelector('.edit-expense-btn');
                const deleteBtn = row.querySelector('.delete-expense-btn');
                
                viewBtn.dataset.date = exp.date;
                viewBtn.dataset.category = exp.category;
                viewBtn.dataset.amount = exp.amount;
                viewBtn.dataset.description = exp.description;
                
                editBtn.dataset.date = exp.date;
                editBtn.dataset.category = exp.category_code;
                editBtn.dataset.amount = exp.amount;
                editBtn.dataset.description = exp.description;
                
                deleteBtn.dataset.category = exp.category;
                deleteBtn.dataset.amount = exp.amount;
                deleteBtn.dataset.description = exp.description;
                deleteBtn.dataset.date = exp.date;
                
                bootstrap.Modal.getInstance(document.getElementById('editExpenseModal')).hide();
                showToast('Expense updated!', 'success');
                updateStats();
            }
        })
        .catch(e => showToast('Error updating expense', 'error'));
    });

    // Delete Expense
    document.getElementById('deleteConfirmBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', getCSRFToken());
        
        fetch(`{% url "expense_delete" 99999 %}`.replace('99999', currentExpenseId), {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCSRFToken()}
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                const row = document.querySelector(`tr[data-expense-id="${data.expense_id}"]`);
                if (row) row.remove();
                
                const tbody = document.querySelector('tbody');
                if (!tbody || tbody.children.length === 0) {
                    const table = document.querySelector('.table-responsive');
                    if (table) {
                        table.outerHTML = `<div class="alert alert-info"><span>No expenses yet. Start tracking your spending!</span> <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addExpenseModal">Add Expense</button></div>`;
                    }
                }
                
                bootstrap.Modal.getInstance(document.getElementById('deleteExpenseModal')).hide();
                showToast('Expense deleted!', 'success');
                updateStats();
            }
        })
        .catch(e => showToast('Error deleting expense', 'error'));
    });

    // Set default date
    document.getElementById('addDate').value = new Date().toISOString().split('T')[0];
});
</script>
{% endblock %}
